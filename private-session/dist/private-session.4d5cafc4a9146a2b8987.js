(()=>{const t="Private session",n=100,e="div.main-topBar-topbarContentRight > button.main-userWidget-box",o="ul.main-contextMenu-menu",i="ps-persistent-item";let u=!1,r=null,c=!1,s=!1,a=0,f=!1,l=!1,m=!1,w=null;async function d(){for(let e=0;e<2;e++){const e=document.querySelectorAll("button.main-actionButtons-button");for(const n of e)if(n.textContent.includes(t))return n;await new Promise((t=>setTimeout(t,n)))}return null}function p(){localStorage.setItem("private-session-persistent-mode",u.toString())}async function y(){const t=await d();return l=!!t,l}function g(){if(w&&(clearTimeout(w),w=null),document.querySelector("ul.main-contextMenu-menu")){const t=document.querySelector(e);t&&(t.click(),w=setTimeout((()=>{document.querySelector("ul.main-contextMenu-menu")&&t.click(),w=null}),150))}}async function b(o=!0){if(s)return!1;const i=Date.now();if(i-a<500)return!1;try{if(await y())return!0;if(!o)return!1;if(s=!0,a=i,g(),await new Promise((t=>setTimeout(t,150))),!await async function(t){const e=await async function(t){for(let e=0;e<3;e++){{const n=document.querySelector(t);if(n)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return e?(e.click(),e):null}(e))return s=!1,!1;await new Promise((t=>setTimeout(t,200)));const u=await async function(t){for(let e=0;e<3;e++){const e=document.querySelectorAll("ul > li > button.main-contextMenu-menuItemButton[role='menuitemcheckbox']");if(e.length>0)for(const n of e){const e=n.querySelector("span");if(e&&e.textContent.trim()===t)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return u?(await async function(t){return!!t.querySelector("svg")}(u)?l=!0:(u.click(),l=!0,await new Promise((t=>setTimeout(t,n)))),g(),s=!1,!0):(g(),s=!1,!1)}catch(t){return g(),s=!1,!1}}function v(){u=!0,p(),r||(r=()=>{f||(f=!0,setTimeout((async()=>{f=!1,!await y()&&u&&await b(!0)}),500))},window.addEventListener("focus",r))}function h(){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("role","img"),t.setAttribute("height","20"),t.setAttribute("width","20"),t.setAttribute("aria-hidden","true"),t.setAttribute("viewBox","0 0 20 20"),t.style.marginLeft="8px",t.style.verticalAlign="middle";const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("cx","10"),n.setAttribute("cy","10"),n.setAttribute("r","9"),n.setAttribute("fill","#1DB954");const e=document.createElementNS("http://www.w3.org/2000/svg","path");return e.setAttribute("d","M8.5 13.5l-3.5-3.5 1.5-1.5 2 2 4.5-4.5 1.5 1.5z"),e.setAttribute("fill","#FFFFFF"),t.appendChild(n),t.appendChild(e),t}function P(t){let n=t;if(!n){const t=document.querySelector(o);t&&(n=t.querySelector("#"+i))}if(n){const t=n.querySelector("button");if(t){t.setAttribute("aria-checked",u?"true":"false");const n=t.querySelector("svg");u&&!n?t.appendChild(h()):!u&&n&&n.remove()}}}function T(n){if(!n)return;let e=n.querySelector("#"+i);e?P(e):e=function(n){const e=Array.from(n.querySelectorAll("span")).find((n=>n.textContent===t));if(!e)return null;const o=e.closest("li");if(!o)return null;const c=o.cloneNode(!0);c.id=i;const s=c.querySelector("span");s&&(s.textContent="Persistent Privacy");const a=c.querySelector("button");return a&&(a.setAttribute("aria-checked",u?"true":"false"),a.querySelectorAll("svg").forEach((t=>t.remove())),u&&a.appendChild(h()),a.replaceWith(a.cloneNode(!0)),c.querySelector("button").addEventListener("click",(()=>{u?(u=!1,p(),r&&(window.removeEventListener("focus",r),r=null)):v(),P(c)}))),o.after(c),c}(n),u&&e&&d().then((e=>{if(!e){const e=function(t,n){const e=Array.from(t.querySelectorAll("span"));for(const t of e)if(t.textContent===n)return t.closest("button");return null}(n,t);e&&!e.querySelector("svg")&&e.click()}}))}(async t=>{for(;!t();)await new Promise((t=>setTimeout(t,n)));await async function(){!function(){const t=localStorage.getItem("private-session-persistent-mode");u="true"===t}(),new MutationObserver((t=>{let n=!1,e=!1,u=null;for(const r of t){if(!c&&r.addedNodes)for(const t of r.addedNodes)if(1===t.nodeType){const e=t.matches?.(o)?t:t.querySelector?.(o);if(e){n=!0,u=e;break}}if(c&&r.removedNodes)for(const t of r.removedNodes)if(1===t.nodeType){const n=t.matches?.(o),u=t.querySelector?.("#"+i);if(n||u){e=!0;break}}if(n||e)break}e&&(c=!1),n&&u&&!c&&(T(u),c=!0,a=Date.now())})).observe(document.body,{childList:!0,subtree:!0}),await y(),m=!0,u&&v(),await new Promise((t=>setTimeout(t,800))),l||await b(!0)}()})((()=>Spicetify&&Spicetify.Platform&&Spicetify.Platform.FeedbackAPI&&"complete"===document.readyState))})();