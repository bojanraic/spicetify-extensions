(()=>{const t="Private session",n=100,e="div.main-topBar-topbarContentRight > button.main-userWidget-box",i="ul.main-contextMenu-menu",o="ps-persistent-item";let s=!1,r=null,c=!1,u=!1,a=0,l=!1,f=!1,m=!1,d=null;async function p(){for(let e=0;e<2;e++){const e=document.querySelectorAll("button.main-actionButtons-button");for(const n of e)if(n.textContent.includes(t))return n;await new Promise((t=>setTimeout(t,n)))}return null}function w(){localStorage.setItem("private-session-persistent-mode",s.toString())}async function b(){const t=await p();return f=!!t,f}function y(){if(d&&(clearTimeout(d),d=null),document.querySelector("ul.main-contextMenu-menu")){const t=document.querySelector(e);t&&(t.click(),d=setTimeout((()=>{document.querySelector("ul.main-contextMenu-menu")&&t.click(),d=null}),150))}}async function x(i=!0){if(u)return!1;const o=Date.now();if(o-a<500)return!1;try{if(await b())return!0;if(!i)return!1;if(u=!0,a=o,y(),await new Promise((t=>setTimeout(t,150))),!await async function(t){const e=await async function(t){for(let e=0;e<3;e++){{const n=document.querySelector(t);if(n)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return e?(e.click(),e):null}(e))return u=!1,!1;await new Promise((t=>setTimeout(t,200)));const s=await async function(t){for(let e=0;e<3;e++){const e=document.querySelectorAll("ul > li > button.main-contextMenu-menuItemButton[role='menuitemcheckbox']");if(e.length>0)for(const n of e){const e=n.querySelector("span");if(e&&e.textContent.trim()===t)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return s?(await async function(t){return!!t.querySelector("svg")}(s)?f=!0:(s.click(),f=!0,await new Promise((t=>setTimeout(t,n)))),y(),u=!1,!0):(y(),u=!1,!1)}catch(t){return y(),u=!1,!1}}function g(){s=!0,w(),r||(r=()=>{l||(l=!0,setTimeout((async()=>{l=!1,!await b()&&s&&await x(!0)}),500))},window.addEventListener("focus",r))}function h(t){return`\n    <div class="toggle-switch" style="\n      position: relative;\n      width: 40px;\n      height: 20px;\n      background-color: ${t?"#1DB954":"#535353"};\n      border-radius: 10px;\n      transition: background-color 0.3s;\n    ">\n      <div class="toggle-slider" style="\n        position: absolute;\n        top: 2px;\n        left: ${t?"22px":"2px"};\n        width: 16px;\n        height: 16px;\n        background-color: white;\n        border-radius: 50%;\n        transition: left 0.3s;\n      "></div>\n    </div>\n  `}function v(n){if(!n)return;let e=n.querySelector("#"+o);e?function(t){let n=t;if(!n){const t=document.querySelector(i);t&&(n=t.querySelector("#"+o))}if(n){const t=n.querySelector("button");if(t){let n=t.querySelector(".sidebar-checkbox");n||(n=document.createElement("span"),n.className="sidebar-checkbox",n.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",t.appendChild(n)),n.innerHTML=h(s),n.title=s?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"}}}(e):e=function(n){const e=Array.from(n.querySelectorAll("span")).find((n=>n.textContent===t));if(!e)return null;const i=e.closest("li");if(!i)return null;const c=document.createElement("li");c.id=o,c.className=i.className;const u=document.createElement("div");u.className="main-contextMenu-menuItemButton",u.style.cssText="display:flex;align-items:center;padding:8px 12px;cursor:pointer;justify-content:space-between;",u.setAttribute("role","menuitem");const a=document.createElement("span");a.textContent="Persistent Privacy";const l=document.createElement("span");return l.className="sidebar-checkbox",l.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",l.innerHTML=h(s),l.title=s?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode",u.appendChild(a),u.appendChild(l),u.addEventListener("mouseover",(()=>u.style.backgroundColor="rgba(255,255,255,0.1)")),u.addEventListener("mouseout",(()=>u.style.backgroundColor="transparent")),u.addEventListener("click",(()=>{s=!s,w(),s?g():(s=!1,w(),r&&(window.removeEventListener("focus",r),r=null)),l.innerHTML=h(s),l.title=s?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"})),c.appendChild(u),i.after(c),c}(n),s&&e&&p().then((e=>{if(!e){const i=function(t,n){const e=Array.from(t.querySelectorAll("span"));for(const t of e)if(t.textContent===n)return t.closest("button");return null}(n,t);i&&!e&&i.click()}}))}(async t=>{for(;!t();)await new Promise((t=>setTimeout(t,n)));await async function(){!function(){const t=localStorage.getItem("private-session-persistent-mode");s="true"===t}(),new MutationObserver((t=>{let n=!1,e=!1,s=null;for(const r of t){if(!c&&r.addedNodes)for(const t of r.addedNodes)if(1===t.nodeType){const e=t.matches?.(i)?t:t.querySelector?.(i);if(e){n=!0,s=e;break}}if(c&&r.removedNodes)for(const t of r.removedNodes)if(1===t.nodeType){const n=t.matches?.(i),s=t.querySelector?.("#"+o);if(n||s){e=!0;break}}if(n||e)break}e&&(c=!1),n&&s&&!c&&(v(s),c=!0,a=Date.now())})).observe(document.body,{childList:!0,subtree:!0}),await b(),m=!0,s&&g(),await new Promise((t=>setTimeout(t,800))),f||await x(!0)}()})((()=>Spicetify&&Spicetify.Platform&&Spicetify.Platform.FeedbackAPI&&"complete"===document.readyState))})();