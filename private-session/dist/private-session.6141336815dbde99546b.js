(()=>{const t="Private session",n=100,e="div.main-topBar-topbarContentRight > button.main-userWidget-box",i="ul.main-contextMenu-menu",o="ps-persistent-item";let s=!1,r=null,c=!1,a=!1,u=0,l=!1,f=!1,m=!1,p=null;async function d(){for(let e=0;e<2;e++){const e=document.querySelectorAll("button.main-actionButtons-button");for(const n of e)if(n.textContent.includes(t))return n;await new Promise((t=>setTimeout(t,n)))}return null}function w(){localStorage.setItem("private-session-persistent-mode",s.toString())}async function b(){const t=await d();return f=!!t,f}function y(){if(p&&(clearTimeout(p),p=null),document.querySelector("ul.main-contextMenu-menu")){const t=document.querySelector(e);t&&(t.click(),p=setTimeout((()=>{document.querySelector("ul.main-contextMenu-menu")&&t.click(),p=null}),150))}}async function x(i=!0){if(a)return!1;const o=Date.now();if(o-u<500)return!1;try{if(await b())return!0;if(!i)return!1;if(a=!0,u=o,y(),await new Promise((t=>setTimeout(t,150))),!await async function(t){const e=await async function(t){for(let e=0;e<3;e++){{const n=document.querySelector(t);if(n)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return e?(e.click(),e):null}(e))return a=!1,!1;await new Promise((t=>setTimeout(t,200)));const s=await async function(t){for(let e=0;e<3;e++){const e=document.querySelectorAll("ul > li > button.main-contextMenu-menuItemButton[role='menuitemcheckbox']");if(e.length>0)for(const n of e){const e=n.querySelector("span");if(e&&e.textContent.trim()===t)return n}await new Promise((t=>setTimeout(t,n)))}return null}(t);return s?(await async function(t){return!!t.querySelector("svg")}(s)?f=!0:(s.click(),f=!0,await new Promise((t=>setTimeout(t,n)))),y(),a=!1,!0):(y(),a=!1,!1)}catch(t){return y(),a=!1,!1}}function g(){s=!0,w(),r||(r=()=>{l||(l=!0,setTimeout((async()=>{l=!1,!await b()&&s&&await x(!0)}),500))},window.addEventListener("focus",r))}function h(t){return`\n    <div class="toggle-switch" style="\n      position: relative;\n      width: 40px;\n      height: 20px;\n      background-color: ${t?"#1DB954":"#535353"};\n      border-radius: 10px;\n      transition: background-color 0.3s;\n    ">\n      <div class="toggle-slider" style="\n        position: absolute;\n        top: 2px;\n        left: ${t?"22px":"2px"};\n        width: 16px;\n        height: 16px;\n        background-color: white;\n        border-radius: 50%;\n        transition: left 0.3s;\n      "></div>\n    </div>\n  `}function v(t,n){const e=Array.from(t.querySelectorAll("span"));for(const t of e)if(t.textContent===n)return t.closest("button");return null}function k(n,e=0){const i=Array.from(n.querySelectorAll("span")).find((n=>n.textContent===t));if(!i)return e<10&&setTimeout((()=>k(n,e+1)),100),null;const c=i.closest("li");if(!c)return null;const a=document.createElement("li");a.id=o,a.className=c.className;const u=document.createElement("div");u.className="main-contextMenu-menuItemButton",u.style.cssText="display:flex;align-items:center;padding:8px 12px;cursor:pointer;justify-content:space-between;",u.setAttribute("role","menuitem");const l=document.createElement("span");l.textContent="Persistent Privacy";const f=document.createElement("span");return f.className="sidebar-checkbox",f.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",f.innerHTML=h(s),f.title=s?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode",u.appendChild(l),u.appendChild(f),u.addEventListener("mouseover",(()=>u.style.backgroundColor="rgba(255,255,255,0.1)")),u.addEventListener("mouseout",(()=>u.style.backgroundColor="transparent")),u.addEventListener("click",(()=>{s=!s,w(),s?g():(s=!1,w(),r&&(window.removeEventListener("focus",r),r=null)),f.innerHTML=h(s),f.title=s?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"})),a.appendChild(u),c.after(a),a}function T(n){if(!n)return;if(!v(n,t))return;let e=n.querySelector("#"+o);e?function(t){let n=t;if(!n){const t=document.querySelector(i);t&&(n=t.querySelector("#"+o))}if(n){const t=n.querySelector("button");if(t){let n=t.querySelector(".sidebar-checkbox");n||(n=document.createElement("span"),n.className="sidebar-checkbox",n.style.cssText="width:40px;height:20px;display:flex;align-items:center;justify-content:center;",t.appendChild(n)),n.innerHTML=h(s),n.title=s?"Click to disable persistent privacy mode":"Click to enable persistent privacy mode"}}}(e):e=k(n),s&&e&&d().then((e=>{if(!e){const i=v(n,t);i&&!e&&i.click()}}))}(async e=>{for(;!e();)await new Promise((t=>setTimeout(t,n)));await async function(){!function(){const t=localStorage.getItem("private-session-persistent-mode");s="true"===t}(),new MutationObserver((n=>{let e=!1,s=!1,r=null;for(const t of n){if(!c&&t.addedNodes)for(const n of t.addedNodes)if(1===n.nodeType){const t=n.matches?.(i)?n:n.querySelector?.(i);if(t){e=!0,r=t;break}}if(c&&t.removedNodes)for(const n of t.removedNodes)if(1===n.nodeType){const t=n.matches?.(i),e=n.querySelector?.("#"+o);if(t||e){s=!0;break}}if(e||s)break}if(s&&(c=!1),e&&r&&!c){const n=Array.from(r.querySelectorAll("span")).find((n=>n.textContent===t)),e=Array.from(r.querySelectorAll("span")).some((t=>"Settings"===t.textContent));(n||e)&&n&&(T(r),c=!0,u=Date.now())}})).observe(document.body,{childList:!0,subtree:!0}),await b(),m=!0,s&&g(),await new Promise((t=>setTimeout(t,800))),f||await x(!0)}()})((()=>Spicetify&&Spicetify.Platform&&Spicetify.Platform.FeedbackAPI&&"complete"===document.readyState))})();